<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Telemetry Player – Lapped / Sprint + Events</title>
    <link rel="stylesheet" href="css/style.css" />

</head>

<body>
  <header>
    <h1>Forza Horizon 5 - Race Analysis</h1>
    <div class="topbar-row">
      <div class="topbar-left">
        <button id="toggleSetupBtn" class="small">Show setup ▾</button>
        <button id="miniModeBtn" class="small">Mini mode: OFF</button>
      </div>
    </div>
    <div id="raceTypeInfo"></div>
    <div id="resultsBar"></div>
  </header>

  <div id="setupPanel">
    <div class="controls">
      <label class="fileButton">
        Select CSVs
        <input type="file" id="csvInput" multiple accept=".csv" />
      </label>
      <button id="loadBtn" class="small">Load CSVs</button>

      <label class="fileButton">
        Select Master JSON
        <input type="file" id="masterJsonInput" accept=".json" />
      </label>
      <button id="useMasterBtn" class="small">Load Master JSON</button>
      <button id="exportMasterBtn" class="small">Export Master JSON</button>
    </div>

    <div class="controls">
      <label><input type="checkbox" id="showTrackSectors" checked> Show track sectors</label>
      <label><input type="checkbox" id="heatToggle" checked> Track speed heatmap</label>
      <label><input type="checkbox" id="confidenceToggle" checked> Confidence shading</label>
      <label><input type="checkbox" id="showSectors" checked> Show sector tables</label>
      <label><input type="checkbox" id="showDeltas" checked> Show deltas</label>
      <label>Sectors:
      <select id="sectorCount">
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4" selected>4</option>
        <option value="5">5</option>
        <option value="6">6</option>
      </select>
      </label>
      <label>Delta Mode:
        <select id="deltaMode">
          <option value="bestLap">Best Lap</option>
          <option value="bestSector" selected>Best Sector</option>
        </select>
      </label>
    </div>

    <div class="controls">
      <button id="cardsMiniBtn" class="small">Cards: Full</button>
      <button id="playbackMiniBtn" class="small">Bottom: Full</button>
      <button id="exportSessionBtn" class="small">Export session JSON</button>
      <button id="saveTrackPngBtn" class="small">Save track PNG</button>
    </div>

    <div class="controls">
      <span style="color:var(--text-soft);">Lap detect:</span>
      <label>Radius (m): <input type="number" id="lapRadiusInput" min="1" max="200" step="1" style="width:70px;"></label>
      <label>Min speed (m/s): <input type="number" id="lapMinSpeedInput" min="0" max="60" step="0.5" style="width:80px;"></label>
      <label>Min samples: <input type="number" id="minLapSamplesInput" min="1" max="2000" step="10" style="width:80px;"></label>
      <label>Min lap dist (m): <input type="number" id="minLapDistanceInput" min="10" max="200000" step="100" style="width:90px;"></label>
      <label>Expected laps: <input type="number" id="expectedLapCountInput" min="0" max="20" step="1" style="width:70px;" placeholder="auto"></label>
      <button id="applyLapDetectBtn" class="small">Apply lap detect</button>
    </div>

    <div class="controls" id="eventControls">
      <span style="color:var(--text-soft);">Timeline mode:</span>
      <button id="timelineUnified" class="small">Unified</button>
      <button id="timelinePerCar" class="small">Per-car</button>

      <label><input type="checkbox" id="showCrash" checked> Crash</label>
      <label><input type="checkbox" id="showCollision" checked> Collision</label>
      <label><input type="checkbox" id="showOvertake" checked> Overtake</label>
      <label><input type="checkbox" id="showFastLap" checked> Fastest Lap</label>
      <label><input type="checkbox" id="showLapStart" checked> Lap Start</label>
    </div>
  </div>

  <div id="mainLayout">
    <div id="trackWrap">
      <h2>Master Track</h2>
      <canvas id="track" width="900" height="600"></canvas>
    </div>
    <div id="dashColumn">
      <div id="dashContainer"></div>
    </div>
  </div>

  <div class="legendRow">
    <div id="legend"></div>
  </div>

  <div id="info">
    If no JSON is loaded, the master is built from telemetry.
    Lapped = first lap averaged &amp; loop closed. Sprint = full run, no closure.
  </div>

  <div id="playbackBar">
    <div id="playbackInner">
      <div class="playbackControlsRow">
        <button id="playBtn">▶ Play</button>
        <button id="pauseBtn">⏸ Pause</button>
        <div class="scrubContainer">
          <button id="playbackCollapseBtn" class="small" title="Toggle bottom panel">▾</button>
          <span style="font-size:11px;color:var(--text-soft);">Time:</span>
          <input type="range" id="scrubber" min="0" max="0" value="0" />
        </div>
        <div id="playbackInfo"></div>
      </div>
      <canvas id="eventTimeline" width="900" height="60"></canvas>
      <div id="deltaPanel">
        <div class="delta-controls">
          <div class="delta-left">
            <label for="primaryCarSelect">Delta source:</label>
            <select id="primaryCarSelect"></select>
          </div>
          <label class="deltaToggleLabel">
            <input type="checkbox" id="deltaShadingToggle">
            Shading
          </label>
        </div>
        <canvas id="deltaTimeline" width="900" height="80"></canvas>
      </div>

      <div id="inputPanel">
        <div class="input-controls">
          <div class="input-left">
            <span>Inputs:</span>
            <label><input type="checkbox" id="inputThrottleToggle" checked> Throttle</label>
            <label><input type="checkbox" id="inputBrakeToggle" checked> Brake</label>
            <label><input type="checkbox" id="inputSteerToggle"> Steering</label>
          </div>
        </div>
        <canvas id="inputTimeline" width="900" height="60"></canvas>
      </div>
    </div>
  </div>

  <div id="eventTooltip"></div>

  <script type="module" src="js/main.js"></script>

</body>

</html>
